<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://xmlns.jcp.org/jsf/core">

<h:head>
    <title>Area Checker</title>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

    <h:outputStylesheet library="css" name="common.css"/>
    <h:outputStylesheet library="css" name="main.css"/>

    <h:outputScript library="js" name="graph-renderer.js"/>
    <h:outputScript library="js" name="graph-interaction.js"/>
    <h:outputScript library="js" name="validation.js"/>
    <h:outputScript library="js" name="ajax-handler.js"/>
</h:head>

<h:body>
    <div class="container">
        <h1>Проверка попадания точки</h1>

        <!-- Основная форма для проверки точки -->
        <h:form id="mainForm" prependId="false">
            <div class="form-block">
                <h3>Координата X:</h3>
                <h:selectOneMenu id="x" value="#{areaCheck.x}">
                    <f:selectItem itemLabel="-4" itemValue="-4"/>
                    <f:selectItem itemLabel="-3" itemValue="-3"/>
                    <f:selectItem itemLabel="-2" itemValue="-2"/>
                    <f:selectItem itemLabel="-1" itemValue="-1"/>
                    <f:selectItem itemLabel="0" itemValue="0"/>
                    <f:selectItem itemLabel="1" itemValue="1"/>
                    <f:selectItem itemLabel="2" itemValue="2"/>
                    <f:selectItem itemLabel="3" itemValue="3"/>
                    <f:selectItem itemLabel="4" itemValue="4"/>
                </h:selectOneMenu>

                <h3>Координата Y:</h3>
                <h:inputText id="y" value="#{areaCheck.y}" styleClass="form-control"/>

                <h3>Радиус R:</h3>
                <h:inputText id="r" value="#{areaCheck.r}" styleClass="form-control">
                </h:inputText>

            </div>

            <div class="form-submit-container">
                <h:commandButton value="Проверить"
                                 onclick="return validateFormBeforeSubmit();"
                                 action="#{areaCheck.checkPoint}"
                                 styleClass="submit-btn">

                    <f:ajax execute="@form"
                            render=":resultsPanel :graphContainer :clearForm:clearBtn"
                            onevent="handleAjaxEvent"/>
                </h:commandButton>
            </div>

        <!-- График -->
            <div class="graph-section">
                <h3>График области</h3>
                <div id="graphContainer"></div>
            </div>

        <!-- Таблица результатов -->
            <h:panelGroup id="resultsPanel">
                <div class="results-section">
                    <h3>История проверок</h3>

                    <h:dataTable id="resultsTable" value="#{resultsBean.results}" var="result"
                                 styleClass="results-table"
                                 rendered="#{not empty resultsBean.results}">
                        <h:column>
                            <f:facet name="header">X</f:facet>
                            #{result.x}
                        </h:column>
                        <h:column>
                            <f:facet name="header">Y</f:facet>
                            #{result.y}
                        </h:column>
                        <h:column>
                            <f:facet name="header">R</f:facet>
                            #{result.r}
                        </h:column>
                        <h:column>
                            <f:facet name="header">Попадание</f:facet>
                            <span class="#{result.hit ? 'hit' : 'miss'}"
                                  data-hit="#{result.hit}">
                                #{result.hitText}
                            </span>
                        </h:column>
                        <h:column>
                            <f:facet name="header">Время запроса</f:facet>
                            #{result.formattedCheckTime}
                        </h:column>
                        <h:column>
                            <f:facet name="header">Время выполнения</f:facet>
                            #{result.formattedExecutionTime}
                        </h:column>
                    </h:dataTable>

                <!-- Сообщение если нет результатов -->
                    <h:outputText value="Нет сохраненных результатов"
                                  rendered="#{empty resultsBean.results}"
                                  style="display: block; text-align: center; color: #777; margin: 20px 0;"/>
                </div>
            </h:panelGroup>

        <!-- Кнопка очистки в отдельной форме -->
            <div style="text-align: center; margin-top: 15px;">
                <h:commandButton value="Очистить историю"
                                 action="#{resultsBean.clearResults()}"
                                 styleClass="clear-btn">
                    <f:ajax execute="@this"
                            render="resultsPanel graphContainer"
                            onevent="handleClearAjax"/>
                </h:commandButton>
            </div>
        </h:form>

        <h:form id="graphForm" prependId="false" style="display: none;">
            <h:inputHidden id="graphX" value="#{areaCheck.x}" />
            <h:inputHidden id="graphY" value="#{areaCheck.y}" />
            <h:inputHidden id="graphR" value="#{areaCheck.r}" />

            <h:commandButton id="graphSubmitBtn"
                             value="Проверить"
                             action="#{areaCheck.checkPoint}">
                <f:ajax execute="@form"
                        render=":resultsPanel :graphContainer"
                        onevent="handleGraphAjax"/>
            </h:commandButton>
        </h:form>

    </div>

    <script>
        // Запуск инициализации
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Страница загружена (AJAX режим)');

            // Инициализируем AJAX систему
            if (typeof initializeAjaxSystem === 'function') {
                initializeAjaxSystem();
            }

            // Инициализируем страницу
            if (typeof initializePage === 'function') {
                initializePage();
            } else {
                console.error('initializePage не найдена!');
                // Создаем график вручную
                setTimeout(function() {
                    if (typeof createGraph === 'function') {
                        createGraph();
                        // Инициализируем валидацию
                        if (typeof initializeFormValidation === 'function') {
                            initializeFormValidation();
                        }
                        // Загружаем историю
                        setTimeout(function() {
                            if (typeof displayHistoryPoints === 'function') {
                                displayHistoryPoints();
                            }
                        }, 500);
                    }
                }, 100);
            }
        });
    </script>

</h:body>
</html>